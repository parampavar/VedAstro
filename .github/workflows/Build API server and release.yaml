name: Build and Release API Server

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest  # Use Windows environment

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up .NET (adjust the version as needed)
      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: '7.0.0'  # Update to match your project's .NET version

      # Build the Azure Functions project
      - name: Build Azure Functions project
        shell: pwsh  # Use PowerShell
        run: |
          cd API
          dotnet publish -c Release -o publish

      # Zip the build output
      - name: Zip build output
        shell: pwsh
        run: |
          $publishPath = 'API\publish'
          Compress-Archive -Path "$publishPath\*" -DestinationPath 'VedAstro-API-Server.zip'

      # Get shortened commit hash
      - name: Get short commit hash
        id: vars
        shell: pwsh
        run: |
          $shortSha = $env:GITHUB_SHA.Substring(0,7)
          echo "SHORT_SHA=$shortSha" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      # Create Release and Upload Asset
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: VedAstro-API-Server.zip
          tag_name: ${{ env.SHORT_SHA }}
          name: API Server ${{ env.SHORT_SHA }}
          body: |
            ## How to Use this Release

            **👣 Steps:**

            1. **Download the `VedAstro-API-Server.zip`** file attached below.
            2. **Extract** the contents of the zip file to a directory of your choice.
            3. **Open a command prompt or terminal** and navigate to the extracted directory.
            4. **Start the Azure Functions host** by running:

               ```bash
               func start
               ```

               Ensure you have the [Azure Functions Core Tools](https://docs.microsoft.com/azure/azure-functions/functions-run-local) installed.

            5. **Access your functions** using the URLs provided in the console output.
            6. 🎈 Enjoy the worlds 1st open-source, non-profit vedic astrology API server

            💌 Donate to Support the project --> vedastro.org/Donate.html
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}  # Automatically provided by GitHub Actions

